---
name: decoder/aws-cloudtrail/0

metadata:
  title: Wazuh integration of AWS Cloudtrail Decoder
  description: Decoder for wazuh integration of AWS CloudTrail Logs
  module: AWS
  compatibility: >
    This decoder has been tested on Wazuh version 4.4
  references:
    - https://documentation.wazuh.com/current/amazon/services/supported-services/cloudtrail.html#amazon-cloudtrail
    - https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-event-reference-record-contents.html
    - https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-log-file-examples.html
  versions:
    - "4.4"
  author:
      name: Wazuh, Inc.
      url: https://wazuh.com
      date: 2023/01/18

# Example of Wazuh's integration with AWS Cloudtrail log:
# {"aws":{"source":"cloudtrail","eventVers|ion":"some-event-version","eventID":"some-event-id","eventTime":"2018-08-24T17:20:08Z","log_file":"some-log-file.json.gz","additionalEventData":{"MFAUsed":"No","LoginTo":"https://console.aws.amazon.com/console/home","MobileVersion":"No"},"eventType":"AwsConsoleSignIn","errorMessage":"Failed authentication","responseElements":{"ConsoleLogin":"Failure"},"awsRegion":"us-east-1","eventName":"ConsoleLogin","userIdentity":{"userName":"some-user-name","accessKeyId":"some-access-key","type":"IAMUser","principalId":"some-principal-id","accountId":"0303456"},"eventSource":"signin.amazonaws.com","userAgent":"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0","sourceIPAddress":"7.222.123.101","recipientAccountId":"1020304050607080"},"integration":"aws"}
# {"aws":{"log_info":{"log_file":"AWSLogs/166157441623/CloudTrail/us-west-1/2023/04/11/166157441623_CloudTrail_us-west-1_20230411T1755Z_2CqtXDyI0zFiYm1J.json","s3bucket":"wazuh-aws-wodle-cloudtrail"},"eventVersion":"1.08","userIdentity":{"type":"AssumedRole","principalId":"AROASNL6BLJLQJ242VAU2:37521ec0-a687-437d-b34d-841446447e42","arn":"arn:aws:sts::166157441623:assumed-role/AmazonSSMRoleForAutomationAssumeQuickSetup/37521ec0-a687-437d-b34d-841446447e42","accountId":"166157441623","sessionContext":{"sessionIssuer":{"type":"Role","principalId":"AROASNL6BLJLQJ242VAU2","arn":"arn:aws:iam::166157441623:role/AmazonSSMRoleForAutomationAssumeQuickSetup","accountId":"166157441623","userName":"AmazonSSMRoleForAutomationAssumeQuickSetup"},"attributes":{"creationDate":"2021-07-02T17:50:18Z","mfaAuthenticated":"false"}},"invokedBy":"ssm.amazonaws.com"},"eventTime":"2021-07-02T17:50:19Z","eventSource":"ec2.amazonaws.com","eventName":"AssociateIamInstanceProfile","awsRegion":"us-west-1","sourceIPAddress":"ssm.amazonaws.com","userAgent":"ssm.amazonaws.com","errorCode":"Client.InvalidInstanceID.NotFound","errorMessage":"The instance ID 'i-0c01c461a47b39304' does not exist","requestParameters":{"AssociateIamInstanceProfileRequest":{"InstanceId":"i-0c01c461a47b39304","IamInstanceProfile":{"Arn":"arn:aws:iam::166157441623:instance-profile/AmazonSSMRoleForInstancesQuickSetup","Name":"AmazonSSMRoleForInstancesQuickSetup"}}},"requestID":"3b8970b6-3f9d-405f-bcd1-bb03d6719d8d","eventID":"7bbf9f2c-6412-4b3e-85c3-c7f68b1aef09","readOnly":"false","eventType":"AwsApiCall","managementEvent":"true","recipientAccountId":"166157441623","eventCategory":"Management","source":"cloudtrail","aws_account_id":"166157441623"}}
# {"aws":{"log_info":{"log_file":"AWSLogs/166157441623/CloudTrail/us-west-1/2023/04/11/166157441623_CloudTrail_us-west-1_20230411T1755Z_2CqtXDyI0zFiYm1J.json","s3bucket":"wazuh-aws-wodle-cloudtrail"},"eventVersion":"1.08","userIdentity":{"type":"AssumedRole","principalId":"AROAIIS255TYNLSAAAAAA:user@domain.com","arn":"arn:aws:sts::555555555555:assumed-role/AWSReservedSSO_AdministratorAccess_9840b826e5a769a5/user@domain.com","accountId":"0","accessKeyId":"ASIAQZIUAOWZ11111111","sessionContext":{"sessionIssuer":{"type":"Role","principalId":"AROAIIS255TYNLSAAAAAA","arn":"arn:aws:iam::555555555555:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_AdministratorAccess_9840b826e5a769a5","accountId":"555555555555","userName":"AWSReservedSSO_AdministratorAccess_9840b826e5a769a5"},"attributes":{"creationDate":"2023-04-03T17:20:04Z","mfaAuthenticated":"false"}}},"eventTime":"2023-04-03T18:18:09Z","eventSource":"ec2.amazonaws.com","eventName":"ModifyInstanceAttribute","awsRegion":"us-east-1","sourceIPAddress":"192.168.1.1","userAgent":"AWS Internal","requestParameters":{"instanceId":"i-07956458cfac99999","instanceType":{"value":"c5.xlarge"}},"responseElements":{"requestId":"ce2851c0-2132-4b55-a0b3-1bfc57d57db9","_return":"true"},"requestID":"ce2851c0-2132-4b55-a0b3-1bfc57d57db9","eventID":"6c45ee9f-b4e5-455a-96c4-f12c382474d5","readOnly":"false","eventType":"AwsApiCall","managementEvent":"true","recipientAccountID":"555555555555","eventCategory":"Management","sessionCredentialFromConsole":"true","source":"cloudtrail","aws_account_id":"166157441623","source_ip_address":"192.168.1.1"}}
# {"aws":{"log_info":{"log_file":"AWSLogs/166157441623/CloudTrail/us-west-1/2023/04/11/166157441623_CloudTrail_us-west-1_20230411T1755Z_2CqtXDyI0zFiYm1J.json","s3bucket":"wazuh-aws-wodle-cloudtrail"},"eventVersion":"1.08","userIdentity":{"type":"AssumedRole","principalId":"AROAIIS255TYNLSAAAAAA:user@domain.com","arn":"arn:aws:sts::555555555555:assumed-role/AWSReservedSSO_AdministratorAccess_9840b826e5a769a5/user@domain.com","accountId":"0","accessKeyId":"ASIAQZIUAOWZ11111111","sessionContext":{"sessionIssuer":{"type":"Role","principalId":"AROAIIS255TYNLSAAAAAA","arn":"arn:aws:iam::555555555555:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_AdministratorAccess_9840b826e5a769a5","accountId":"555555555555","userName":"AWSReservedSSO_AdministratorAccess_9840b826e5a769a5"},"attributes":{"creationDate":"2023-04-03T17:20:04Z","mfaAuthenticated":"false"}}},"eventTime":"2023-04-03T18:18:09Z","eventSource":"ec2.amazonaws.com","eventName":"StopInstances","awsRegion":"us-east-1","sourceIPAddress":"192.168.1.1","userAgent":"AWS Internal","requestParameters":{"instanceId":"i-07956458cfac99999","instanceType":{"value":"c5.xlarge"}},"responseElements":{"requestId":"ce2851c0-2132-4b55-a0b3-1bfc57d57db9","_return":"true"},"requestID":"ce2851c0-2132-4b55-a0b3-1bfc57d57db9","eventID":"6c45ee9f-b4e5-455a-96c4-f12c382474d5","readOnly":"false","eventType":"AwsApiCall","managementEvent":"true","recipientAccountID":"555555555555","eventCategory":"Management","sessionCredentialFromConsole":"true","source":"cloudtrail","aws_account_id":"166157441623","source_ip_address":"192.168.1.1"}}
# {"aws":{"log_info":{"log_file":"AWSLogs/166157441623/CloudTrail/us-west-1/2023/04/14/166157441623_CloudTrail_us-west-1_20230411T1755Z_2CqtXDyI0zFiYm1J.json","s3bucket":"wazuh-aws-wodle-cloudtrail"},"eventVersion":"1.08","userIdentity":{"type":"AssumedRole","principalId":"AROASNL6BLJLQJ242VAU2:37521ec0-a687-437d-b34d-841446447e42","arn":"arn:aws:sts::166157441623:assumed-role/AmazonSSMRoleForAutomationAssumeQuickSetup/37521ec0-a687-437d-b34d-841446447e42","accountId":"166157441623","sessionContext":{"sessionIssuer":{"type":"Role","principalId":"AROASNL6BLJLQJ242VAU2","arn":"arn:aws:iam::166157441623:role/AmazonSSMRoleForAutomationAssumeQuickSetup","accountId":"166157441623","userName":"AmazonSSMRoleForAutomationAssumeQuickSetup"},"attributes":{"creationDate":"2021-07-02T17:50:18Z","mfaAuthenticated":"false"}},"invokedBy":"ssm.amazonaws.com"},"eventTime":"2021-07-02T17:50:19Z","eventSource":"ec2.amazonaws.com","eventName":"AssociateIamInstanceProfile","awsRegion":"us-west-1","sourceIPAddress":"ssm.amazonaws.com","userAgent":"ssm.amazonaws.com","errorCode":"Client.InvalidInstanceID.NotFound","errorMessage":"The instance ID 'i-0c01c461a47b39304' does not exist","requestParameters":{"AssociateIamInstanceProfileRequest":{"InstanceId":"i-0c01c461a47b39304","IamInstanceProfile":{"Arn":"arn:aws:iam::166157441623:instance-profile/AmazonSSMRoleForInstancesQuickSetup","Name":"AmazonSSMRoleForInstancesQuickSetup"}}},"requestID":"3b8970b6-3f9d-405f-bcd1-bb03d6719d8d","eventID":"7bbf9f2c-6412-4b3e-85c3-c7f68b1aef09","readOnly":"false","eventType":"AwsApiCall","managementEvent":"true","recipientAccountId":"166157441623","eventCategory":"Management","source":"cloudtrail","aws_account_id":"166157441623"}}
# {"aws":{"log_info":{"log_file":"AWSLogs/166157441623/CloudTrail/us-west-1/2023/04/14/166157441623_CloudTrail_us-west-1_20230411T1755Z_2CqtXDyI0zFiYm1J.json","s3bucket":"wazuh-aws-wodle-cloudtrail"},"eventVersion":"1.08","userIdentity":{"type":"AssumedRole","principalId":"AROAIIS255TYNLSAAAAAA:user@domain.com","arn":"arn:aws:sts::555555555555:assumed-role/AWSReservedSSO_AdministratorAccess_9840b826e5a769a5/user@domain.com","accountId":"0","accessKeyId":"ASIAQZIUAOWZ11111111","sessionContext":{"sessionIssuer":{"type":"Role","principalId":"AROAIIS255TYNLSAAAAAA","arn":"arn:aws:iam::555555555555:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_AdministratorAccess_9840b826e5a769a5","accountId":"555555555555","userName":"AWSReservedSSO_AdministratorAccess_9840b826e5a769a5"},"attributes":{"creationDate":"2023-04-03T17:20:04Z","mfaAuthenticated":"false"}}},"eventTime":"2023-04-03T18:18:09Z","eventSource":"ec2.amazonaws.com","eventName":"ModifyInstanceAttribute","awsRegion":"us-east-1","sourceIPAddress":"192.168.1.1","userAgent":"AWS Internal","requestParameters":{"instanceId":"i-07956458cfac99999","instanceType":{"value":"c5.xlarge"}},"responseElements":{"requestId":"ce2851c0-2132-4b55-a0b3-1bfc57d57db9","_return":"true"},"requestID":"ce2851c0-2132-4b55-a0b3-1bfc57d57db9","eventID":"6c45ee9f-b4e5-455a-96c4-f12c382474d5","readOnly":"false","eventType":"AwsApiCall","managementEvent":"true","recipientAccountID":"555555555555","eventCategory":"Management","sessionCredentialFromConsole":"true","source":"cloudtrail","aws_account_id":"166157441623","source_ip_address":"192.168.1.1"}}
# {"aws":{"log_info":{"log_file":"AWSLogs/166157441623/CloudTrail/us-west-1/2023/04/14/166157441623_CloudTrail_us-west-1_20230411T1755Z_2CqtXDyI0zFiYm1J.json","s3bucket":"wazuh-aws-wodle-cloudtrail"},"eventVersion":"1.08","userIdentity":{"type":"AssumedRole","principalId":"AROAIIS255TYNLSAAAAAA:user@domain.com","arn":"arn:aws:sts::555555555555:assumed-role/AWSReservedSSO_AdministratorAccess_9840b826e5a769a5/user@domain.com","accountId":"0","accessKeyId":"ASIAQZIUAOWZ11111111","sessionContext":{"sessionIssuer":{"type":"Role","principalId":"AROAIIS255TYNLSAAAAAA","arn":"arn:aws:iam::555555555555:role/aws-reserved/sso.amazonaws.com/AWSReservedSSO_AdministratorAccess_9840b826e5a769a5","accountId":"555555555555","userName":"AWSReservedSSO_AdministratorAccess_9840b826e5a769a5"},"attributes":{"creationDate":"2023-04-03T17:20:04Z","mfaAuthenticated":"false"}}},"eventTime":"2023-04-03T18:18:09Z","eventSource":"ec2.amazonaws.com","eventName":"StopInstances","awsRegion":"us-east-1","sourceIPAddress":"192.168.1.1","userAgent":"AWS Internal","requestParameters":{"instanceId":"i-07956458cfac99999","instanceType":{"value":"c5.xlarge"}},"responseElements":{"requestId":"ce2851c0-2132-4b55-a0b3-1bfc57d57db9","_return":"true"},"requestID":"ce2851c0-2132-4b55-a0b3-1bfc57d57db9","eventID":"6c45ee9f-b4e5-455a-96c4-f12c382474d5","readOnly":"false","eventType":"AwsApiCall","managementEvent":"true","recipientAccountID":"555555555555","eventCategory":"Management","sessionCredentialFromConsole":"true","source":"cloudtrail","aws_account_id":"166157441623","source_ip_address":"192.168.1.1"}}

sources:
  - decoder/aws-json/0

check:
  - wazuh.source: cloudtrail
  #TODO: Once the events arrive tagged, uncomment these lines below and remove the above line
  # - event.module: aws
  # - event.dataset: aws.cloudtrail

normalize:
  - check:
      - ~json.aws.previousDigestHashAlgorithm: SHA-256
    map:
      - file.hash.sha256: $~json.aws.previousDigestSignature

  - map:
      - event.dataset: aws.cloudtrail
      - aws.cloudtrail.additional_eventdata: $~json.aws.additionalEventData
      - aws.cloudtrail.api_version: $~json.aws.apiVersion
      - aws.cloudtrail.digest.end_time: $~json.aws.digestEndTime
      - aws.cloudtrail.digest.log_files: $~json.aws.logFiles
      - aws.cloudtrail.digest.newest_event_time: $~json.aws.newestEventTime
      - aws.cloudtrail.digest.oldest_event_time: $~json.aws.oldestEventTime
      - aws.cloudtrail.digest.previous_hash_algorithm: $~json.aws.previousDigestHashAlgorithm
      - aws.cloudtrail.digest.previous_s3_bucket: $~json.aws.previousDigestS3Bucket
      - aws.cloudtrail.digest.public_key_fingerprint: $~json.aws.publicKeyFingerprint
      - aws.cloudtrail.digest.s3_bucket: $~json.aws.digestS3Bucket
      - aws.cloudtrail.digest.signature_algorithm: $~json.aws.digestSignatureAlgorithm
      - aws.cloudtrail.digest.start_time: $~json.aws.digestStartTime
      - aws.cloudtrail.error_code: $~json.aws.errorCode
      - aws.cloudtrail.error_message: $~json.aws.errorMessage
      - aws.cloudtrail.event_category: $~json.aws.eventCategory
      - aws.cloudtrail.event_type: $~json.aws.eventType
      - aws.cloudtrail.event_version: $~json.aws.eventVersion
      - aws.cloudtrail.insight_details: $~json.aws.insightDetails
      - aws.cloudtrail.management_event: $~json.aws.managementEvent
      - aws.cloudtrail.read_only: $~json.aws.readOnly
      - aws.cloudtrail.recipient_account_id: $~json.aws.recipientAccountId
      - aws.cloudtrail.request_id: $~json.aws.requestId
      - aws.cloudtrail.request_parameters: $~json.aws.requestParameters
      - aws.cloudtrail.resources.account_id: $~json.aws.resources.accountId
      - aws.cloudtrail.resources.arn: $~json.aws.resources.ARN
      - aws.cloudtrail.resources.type: $~json.aws.resources.type
      - aws.cloudtrail.response_elements: $~json.aws.responseElements
      - aws.cloudtrail.service_event_details: $~json.aws.serviceEventDetails
      - aws.cloudtrail.shared_event_id: $~json.aws.sharedEventId
      - aws.cloudtrail.user_identity.access_key_id: $~json.aws.userIdentity.accessKeyId
      - aws.cloudtrail.user_identity.arn: $~json.aws.userIdentity.arn
      - aws.cloudtrail.user_identity.invoked_by: $~json.aws.userIdentity.invokedBy
      - aws.cloudtrail.user_identity.session_context.creation_date: $~json.aws.userIdentity.sessionContext.attributes.creationDate
      - aws.cloudtrail.user_identity.session_context.mfa_authenticated: $~json.aws.userIdentity.sessionContext.attributes.mfaAuthenticated
      - aws.cloudtrail.user_identity.session_context.session_issuer.account_id: $~json.aws.userIdentity.sessionContext.sessionIssuer.accountId
      - aws.cloudtrail.user_identity.session_context.session_issuer.arn: $~json.aws.userIdentity.sessionContext.sessionIssuer.arn
      - aws.cloudtrail.user_identity.session_context.session_issuer.principal_id: $~json.aws.userIdentity.sessionContext.sessionIssuer.principalId
      - aws.cloudtrail.user_identity.session_context.session_issuer.type: $~json.aws.userIdentity.sessionContext.sessionIssuer.type
      - aws.cloudtrail.user_identity.type: $~json.aws.userIdentity.type
      - aws.cloudtrail.vpc_endpoint_id: $~json.aws.vpcEndpointId

      - cloud.account.id: $~json.aws.userIdentity.accountId
      - cloud.account.id: $~json.aws.awsAccountId
      - user.name: $~json.aws.userIdentity.sessionContext.sessionIssuer.userName
      - user.name: $~json.aws.userIdentity.userName

      - cloud.region: $~json.aws.awsRegion

      - event.action: $~json.aws.eventName
      - event.id: $~json.aws.eventID
      - event.provider: $~json.aws.eventSource
      - event.outcome: success

      - file.path: $~json.aws.previousDigestS3Object

      - related.hash: $~json.aws.previousDigestSignature

      - related.user: +array_append/$~json.aws.requestParameters.userName
      - related.user: +array_append/$~json.aws.cloudtrail.flattened.request_parameters.userName
      - related.user: +array_append/$~json.aws.requestParameters.newUserName
      - related.user: +array_append/$~json.aws.cloudtrail.flattened.request_parameters.newUserName

      - source.address: $~json.aws.sourceIPAddress #TODO: does it add any value to parse it with ip?
      - source.ip: $~json.aws.sourceIPAddress
      # TODO: implement geolocalization
      # source.geo: +geo/$source.ip
      # source.as: +geo/$source.ip # database_file: GeoLite2-ASN.mmdb | properties:[asn, organization_name]

      - timestamp: $~json.aws.eventTime

      - user_agent: $~json.aws.userAgent
      - user_agent.original: $~json.aws.userAgent
      - user.id: $~json.aws.userIdentity.principalId

      - wazuh.decoders: +array_append/aws-cloudtrail

  - check:
      # TODO: need a HF to check a string length, used by flattened should be less than 32766
      - aws.cloudtrail.request_parameters: +exists
    map:
      - aws.cloudtrail.flattened.request_parameters: $~json.aws.requestParameters
      - aws.cloudtrail.flattened.response_elements: $~json.aws.responseElements
      - aws.cloudtrail.flattened.additional_eventdata: $~json.aws.additionalEventData
      - aws.cloudtrail.flattened.service_event_details: $~json.aws.serviceEventDetails
      - aws.cloudtrail.console_login.login_to: $~json.aws.additionalEventData.MobileVersion.LoginTo
      - aws.cloudtrail.console_login.mobile_version: true
      - aws.cloudtrail.console_login.mfa_used: true
      - user.changes.name: $~json.aws.cloudtrail.flattened.request_parameters.newUserName
      - user.target.name: $~json.aws.cloudtrail.flattened.request_parameters.userName
      - group.name: $~json.aws.cloudtrail.flattened.request_parameters.groupName
      - group.id: $~json.aws.cloudtrail.flattened.response_elements.group.groupId
      - user.target.id: $~json.aws.cloudtrail.flattened.response_elements.user.userId

  - check:
      - ~json.aws.additionalEventData.MobileVersion: No
    map:
      - aws.cloudtrail.console_login.mobile_version: false

  - check:
      - ~json.aws.additionalEventData.MobileVersion.MFAUsed: No
    map:
      - aws.cloudtrail.console_login.mfa_used: false

  - check: +exists/aws.cloudtrail.error_code OR +exists/aws.cloudtrail.error_message
    map:
      - event.outcome: failure

  - check:
      - ~json.aws.responseElements.ConsoleLogin: ConsoleLogin
    map:
      - event.outcome: +downcase/aws.cloudtrail.flattened.response_elements.ConsoleLogin

  - map:
      - ~json: +delete
